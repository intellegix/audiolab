# AudioLab Redis Configuration
# Optimized for real-time audio session management and caching

# ============================================================================
# NETWORK & SECURITY
# ============================================================================
# Bind to all interfaces for Docker networking
bind 0.0.0.0

# Default port
port 6379

# Disable protected mode for Docker environment
protected-mode no

# Maximum number of clients
maxclients 1000

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================
# Maximum memory usage (256MB - adjust based on available RAM)
maxmemory 268435456

# Memory eviction policy - remove least recently used keys when memory limit reached
maxmemory-policy allkeys-lru

# ============================================================================
# PERSISTENCE (Disabled for real-time performance)
# ============================================================================
# Disable RDB snapshots for better real-time performance
save ""

# Disable AOF (Append Only File) for better performance
appendonly no

# ============================================================================
# REAL-TIME OPTIMIZATIONS
# ============================================================================
# TCP keepalive for WebSocket connections
tcp-keepalive 60

# Disable TCP_NODELAY for better throughput (comment out for low latency)
# tcp-nodelay no

# Client output buffer limits for real-time data
# Normal clients: 0 0 0 (unlimited)
client-output-buffer-limit normal 0 0 0

# Pub/Sub clients: 32mb hard limit, 8mb soft limit, 60 second soft limit
client-output-buffer-limit pubsub 33554432 8388608 60

# Slave clients: 256mb hard limit, 64mb soft limit, 60 second soft limit
client-output-buffer-limit replica 268435456 67108864 60

# ============================================================================
# AUDIO SESSION CONFIGURATION
# ============================================================================
# Default database for audio sessions
databases 16

# Key expiration for session management (30 minutes)
# This will be set programmatically, but can be overridden here

# Hash max ziplist entries (optimize for small audio metadata objects)
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List max ziplist size (optimize for audio buffer queues)
list-max-ziplist-size -2

# Set max intset entries (for small audio device ID sets)
set-max-intset-entries 512

# Sorted set max ziplist entries (for timeline data)
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# ============================================================================
# LOGGING & MONITORING
# ============================================================================
# Log level: debug, verbose, notice, warning
loglevel notice

# Log to stdout for Docker logging
logfile ""

# ============================================================================
# PERFORMANCE TUNING
# ============================================================================
# Background save frequency (disabled for real-time)
# stop-writes-on-bgsave-error no

# LZF compression for RDB (disabled since we disabled RDB)
# rdbcompression yes

# Checksum for RDB (disabled since we disabled RDB)
# rdbchecksum yes

# Lazy deletion for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# Threaded I/O (Redis 6+) - use multiple threads for I/O operations
io-threads 2
io-threads-do-reads yes

# ============================================================================
# AUDIO-SPECIFIC OPTIMIZATIONS
# ============================================================================
# Timeout for idle clients (15 minutes for audio sessions)
timeout 900

# HyperLogLog sparse representation limits
hll-sparse-max-bytes 3000

# Active rehashing for better performance
activerehashing yes

# Client query buffer limit (4mb for large audio metadata)
client-query-buffer-limit 4194304

# ============================================================================
# REDIS MODULES (if needed for audio processing)
# ============================================================================
# Example: RedisTimeSeries for audio timeline data
# loadmodule /opt/redis-stack/lib/redistimeseries.so

# ============================================================================
# LUA SCRIPTING
# ============================================================================
# Lua scripting timeout (5 seconds)
lua-time-limit 5000

# ============================================================================
# SLOW LOG (for monitoring audio processing performance)
# ============================================================================
# Slow query log threshold (100ms)
slowlog-log-slower-than 100000

# Max slow log entries
slowlog-max-len 128

# ============================================================================
# NOTIFICATION & KEYSPACE EVENTS
# ============================================================================
# Enable keyspace events for audio session monitoring
# K = keyspace events, E = keyevent events, x = expired events
notify-keyspace-events "Kx"